/**
 * main.js - REDIRECCI√ìN INMEDIATA (sin setTimeout que est√° fallando)
 */

import { auth } from './auth.js';
import { ui } from './ui.js';
import { storage } from './storage.js';
import { validation } from './validation.js';

class LoginApp {
  constructor() {
    this.form = null;
    this.isLoading = false;
    this.init();
  }

  init() {
    console.log('üöÄ Iniciando aplicaci√≥n de login...');
    this.checkExistingSession();
    this.setupDOM();
    this.setupEvents();
    console.log('‚úÖ Login inicializado correctamente');
  }

  async checkExistingSession() {
    const token = storage.getToken();
    if (token) {
      const isValid = await auth.validateToken(token);
      if (isValid) {
        ui.showToast('Sesi√≥n v√°lida, redirigiendo...', 'success');
        // REDIRECCI√ìN INMEDIATA - SIN TIMEOUT
        this.executeRedirect();
        return;
      } else {
        storage.clearAll();
      }
    }
  }

  setupDOM() {
    this.form = document.getElementById('loginForm');
    this.emailInput = document.getElementById('email');
    this.passwordInput = document.getElementById('password');
    this.rememberCheckbox = document.getElementById('rememberMe');
    this.loginButton = document.getElementById('loginButton');
    this.passwordToggle = document.getElementById('passwordToggle');
  }

  setupEvents() {
    if (!this.form) return;

    this.form.addEventListener('submit', (e) => this.handleSubmit(e));
    
    if (this.passwordToggle) {
      this.passwordToggle.addEventListener('click', () => this.togglePassword());
    }
    
    if (this.emailInput) {
      this.emailInput.addEventListener('blur', () => this.validateEmail());
      this.emailInput.addEventListener('input', () => ui.clearFieldError('email'));
    }
    
    if (this.passwordInput) {
      this.passwordInput.addEventListener('input', () => ui.clearFieldError('password'));
    }
    
    [this.emailInput, this.passwordInput].forEach(input => {
      if (input) {
        input.addEventListener('input', () => ui.hideGlobalError());
      }
    });
  }

  async handleSubmit(event) {
    event.preventDefault();
    
    if (this.isLoading) return;
    
    const formData = this.getFormData();
    ui.clearAllErrors();
    
    const validationResult = validation.validateLoginData(formData.email, formData.password);
    
    if (!validationResult.isValid) {
      Object.keys(validationResult.errors).forEach(field => {
        ui.showFieldError(field, validationResult.errors[field]);
      });
      return;
    }
    
    await this.performLogin(formData);
  }

  getFormData() {
    return {
      email: this.emailInput?.value.trim() || '',
      password: this.passwordInput?.value || '',
      rememberMe: this.rememberCheckbox?.checked || false
    };
  }

  async performLogin(data) {
    this.setLoadingState(true);
    ui.hideGlobalError();
    
    try {
      console.log('üîê Ejecutando login...');
      const result = await auth.login(data.email, data.password);
      
      if (result.success) {
        console.log('‚úÖ Login exitoso, guardando datos...');
        
        // Guardar datos
        await this.saveAuthData(result.data, data.rememberMe);
        
        // Verificar guardado
        const savedToken = storage.getToken();
        console.log('üíæ Token guardado:', !!savedToken);
        
        // Mostrar √©xito
        ui.showToast('¬°Login exitoso! Redirigiendo...', 'success');
        
        console.log('üöÄ EJECUTANDO REDIRECCI√ìN INMEDIATA...');
        
        // ‚úÖ REDIRECCI√ìN INMEDIATA - SIN TIMEOUT
        this.executeRedirect();
        
      } else {
        console.error('‚ùå Login fall√≥:', result.message);
        ui.showGlobalError(result.message || 'Error al iniciar sesi√≥n');
      }
      
    } catch (error) {
      console.error('üí• Error en login:', error);
      ui.showGlobalError('Error de conexi√≥n. Verifica tu internet.');
    } finally {
      this.setLoadingState(false);
    }
  }

  async saveAuthData(loginData, remember) {
    try {
      // Guardar usando storage.js
      storage.saveTokens(loginData.access_token, loginData.refresh_token, remember);
      storage.saveUserData(loginData.user, remember);
      
      // Tambi√©n guardar directamente para compatibilidad
      const targetStorage = remember ? localStorage : sessionStorage;
      targetStorage.setItem('access_token', loginData.access_token);
      targetStorage.setItem('refresh_token', loginData.refresh_token);
      targetStorage.setItem('user_data', JSON.stringify(loginData.user));
      
      console.log('‚úÖ Datos guardados correctamente');
      
    } catch (error) {
      console.error('üí• Error guardando datos:', error);
      throw error;
    }
  }

  /**
   * üöÄ REDIRECCI√ìN INMEDIATA Y M√öLTIPLE
   */
  executeRedirect() {
    console.log('üöÄ === EJECUTANDO REDIRECCI√ìN INMEDIATA ===');
    
    // Verificar token antes de redireccionar
    const token = storage.getToken();
    if (!token) {
      console.error('‚ùå CR√çTICO: No hay token para redireccionar');
      ui.showToast('Error: Sesi√≥n no guardada', 'error');
      return;
    }
    
    console.log('‚úÖ Token verificado, procediendo con redirecci√≥n...');
    
    try {
      // üéØ M√âTODO 1: Redirecci√≥n directa inmediata
      console.log('1Ô∏è‚É£ Intentando redirecci√≥n directa...');
      window.location.href = 'dashboard.html';
      
      // üéØ M√âTODO 2: Fallback inmediato con replace
      console.log('2Ô∏è‚É£ Ejecutando fallback con replace...');
      window.location.replace('dashboard.html');
      
      // üéØ M√âTODO 3: Fallback con assign
      console.log('3Ô∏è‚É£ Ejecutando fallback con assign...');
      window.location.assign('dashboard.html');
      
      // üéØ M√âTODO 4: √öltimo fallback
      console.log('4Ô∏è‚É£ √öltimo fallback...');
      window.location = 'dashboard.html';
      
    } catch (error) {
      console.error('üí• ERROR EN TODOS LOS M√âTODOS DE REDIRECCI√ìN:', error);
      
      // üÜò M√âTODO DE EMERGENCIA: Crear enlace manual
      this.createManualRedirectLink();
    }
  }

  /**
   * üÜò M√©todo de emergencia si la redirecci√≥n falla
   */
  createManualRedirectLink() {
    console.log('üÜò Creando enlace manual de emergencia...');
    
    // Crear overlay con enlace manual
    const overlay = document.createElement('div');
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999999;
      color: white;
      font-family: Arial, sans-serif;
    `;
    
    const userData = storage.getUserData();
    
    overlay.innerHTML = `
      <div style="text-align: center; padding: 40px; background: #1a1a1a; border-radius: 15px; max-width: 500px;">
        <h2 style="color: #4CAF50; margin-bottom: 20px;">
          üéâ ¬°Login Exitoso!
        </h2>
        <p style="margin-bottom: 15px;">
          <strong>Usuario:</strong> ${userData?.username || 'Cargado'}
        </p>
        <p style="margin-bottom: 30px;">
          Tu sesi√≥n se guard√≥ correctamente.
        </p>
        
        <div style="margin: 30px 0;">
          <h3 style="color: #ff9800; margin-bottom: 15px;">
            ‚ö†Ô∏è Redirecci√≥n autom√°tica fall√≥
          </h3>
          <p style="margin-bottom: 20px;">
            Haz clic en el bot√≥n para acceder al dashboard:
          </p>
        </div>
        
        <button 
          onclick="window.location.href='dashboard.html'" 
          style="
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            width: 200px;
            display: block;
            margin: 10px auto;
          "
          onmouseover="this.style.opacity='0.9'"
          onmouseout="this.style.opacity='1'"
        >
          üöÄ Ir al Dashboard
        </button>
        
        <div style="margin-top: 30px; font-size: 14px; color: #666;">
          <p>Si el bot√≥n no funciona, verifica que dashboard.html existe en tu proyecto.</p>
        </div>
      </div>
    `;
    
    document.body.appendChild(overlay);
    
    // Tambi√©n mostrar toast con instrucciones
    ui.showToast('Redirecci√≥n manual creada. Haz clic en el bot√≥n.', 'info', 10000);
  }

  // Resto de m√©todos sin cambios...
  togglePassword() {
    if (!this.passwordInput || !this.passwordToggle) return;
    const isPassword = this.passwordInput.type === 'password';
    this.passwordInput.type = isPassword ? 'text' : 'password';
    const icon = this.passwordToggle.querySelector('i');
    if (icon) {
      icon.className = isPassword ? 'fas fa-eye-slash' : 'fas fa-eye';
    }
  }

  validateEmail() {
    if (!this.emailInput) return true;
    const email = this.emailInput.value.trim();
    if (email && !validation.validateEmail(email)) {
      ui.showFieldError('email', 'Formato de email inv√°lido');
      return false;
    }
    ui.clearFieldError('email');
    return true;
  }

  setLoadingState(loading) {
    this.isLoading = loading;
    if (!this.loginButton) return;
    
    if (loading) {
      this.loginButton.classList.add('loading');
      this.loginButton.disabled = true;
      const buttonText = this.loginButton.querySelector('.button-text');
      const buttonLoader = this.loginButton.querySelector('.button-loader');
      if (buttonText) buttonText.style.display = 'none';
      if (buttonLoader) buttonLoader.style.display = 'flex';
    } else {
      this.loginButton.classList.remove('loading');
      this.loginButton.disabled = false;
      const buttonText = this.loginButton.querySelector('.button-text');
      const buttonLoader = this.loginButton.querySelector('.button-loader');
      if (buttonText) buttonText.style.display = 'inline';
      if (buttonLoader) buttonLoader.style.display = 'none';
    }
  }
}

document.addEventListener('DOMContentLoaded', () => {
  console.log('üåü DOM READY - INICIANDO LOGIN CON REDIRECCI√ìN INMEDIATA');
  new LoginApp();
});